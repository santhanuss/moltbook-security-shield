name: Moltbook Security Monitor

on:
  schedule:
    # Run every 30 minutes (GitHub Actions limit for free tier)
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'scripts/moltbook_scanner.py'

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Run security scan
      env:
        MOLTBOOK_API_KEY: ${{ secrets.MOLTBOOK_API_KEY }}
      run: |
        cd scripts
        python moltbook_scanner.py
        
    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scan-results-${{ github.run_number }}
        path: scripts/scan_results.json
        retention-days: 30
        
    - name: Check for threats
      id: threat_check
      run: |
        if [ -f scripts/scan_results.json ]; then
          THREATS=$(python -c "import json; data=json.load(open('scripts/scan_results.json')); print(data.get('threats_found', 0))")
          echo "threats=$THREATS" >> $GITHUB_OUTPUT
          echo "Found $THREATS threats"
        fi
        
    - name: Create issue for threats
      if: steps.threat_check.outputs.threats > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('scripts/scan_results.json', 'utf8'));
          
          let body = `## ðŸš¨ Security Threats Detected\n\n`;
          body += `**Scan Time:** ${results.scan_time}\n`;
          body += `**Total Scanned:** ${results.total_scanned}\n`;
          body += `**Threats Found:** ${results.threats_found}\n\n`;
          
          if (results.high_risk_posts && results.high_risk_posts.length > 0) {
            body += `### High-Risk Posts:\n\n`;
            results.high_risk_posts.forEach((post, i) => {
              body += `**${i+1}. ${post.title}**\n`;
              body += `- Agent: ${post.author}\n`;
              body += `- Risk Score: ${post.risk_score}/100\n`;
              body += `- Threats: ${post.threats.join(', ')}\n`;
              body += `- URL: ${post.url}\n\n`;
            });
          }
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ ${results.threats_found} Threat(s) Detected - ${new Date().toLocaleDateString()}`,
            body: body,
            labels: ['security', 'automated']
          });